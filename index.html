<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefKulkas AI - Cloud Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { background: #fdfdfd; font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); border-radius: 24px; }
        #recipe-content h1 { font-size: 1.5rem; font-weight: 800; color: #1e40af; margin-bottom: 1rem; }
        #recipe-content h2 { font-size: 1.25rem; font-weight: 700; color: #2563eb; margin-top: 1.5rem; }
        #recipe-content ul { list-style: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-extrabold tracking-tight">Kulkas<span class="text-blue-600">AI</span></h1>
            <p id="user-welcome" class="text-sm text-gray-500 italic">Memuat sesi...</p>
        </div>
        <div id="auth-controls" class="flex gap-2">
            </div>
    </div>

    <main class="max-w-3xl mx-auto">
        <div class="glass p-6 md:p-8 shadow-xl mb-8">
            <div id="api-warning" class="hidden bg-amber-50 text-amber-700 p-4 rounded-xl mb-4 text-sm font-medium">
                ‚ö†Ô∏è API Key belum diatur. Klik profil/pengaturan untuk mengisi.
            </div>
            
            <textarea id="ingredients" placeholder="Tulis bahan: 2 butir telur, sosis, nasi..." 
                class="w-full bg-white border border-gray-100 rounded-2xl p-5 outline-none focus:ring-4 focus:ring-blue-100 transition-all h-32 text-lg"></textarea>
            
            <button onclick="generateRecipe()" id="btn-cook"
                class="w-full mt-4 bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-blue-600 transition-all shadow-lg active:scale-95">
                Minta Resep Gemini 2.5
            </button>
        </div>

        <div id="loading" class="hidden text-center py-10 animate-bounce">üç≥ Chef sedang meracik...</div>
        <div id="recipe-card" class="hidden glass p-8 shadow-2xl mb-12 animate-in fade-in duration-500">
            <div id="recipe-content" class="prose prose-slate max-w-none"></div>
        </div>
    </main>

    <div id="settings-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden">
        <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="toggleSettings(false)"></div>
        <div class="glass w-full max-w-sm p-8 relative shadow-2xl">
            <h3 class="text-xl font-bold mb-2">Konfigurasi Cloud</h3>
            <p class="text-xs text-slate-500 mb-6">API Key disimpan aman di akun Google Anda.</p>
            
            <label class="text-[10px] font-bold uppercase text-slate-400">Gemini API Key</label>
            <input type="password" id="api-key-input" placeholder="AIzaSy..." 
                class="w-full p-3 bg-slate-50 border rounded-xl mb-6 outline-none focus:ring-2 focus:ring-blue-400">
            
            <button onclick="saveApiKeyToCloud()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">Simpan ke Cloud</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG: Masukkan data dari Firebase Console Anda di sini
        const firebaseConfig = {
        apiKey: "AIzaSyC67ZMqywH6Nj_Jm5EjStcT4xq_qRv7yB8",
        authDomain: "kulkas-ai.firebaseapp.com",
        projectId: "kulkas-ai",
        storageBucket: "kulkas-ai.firebasestorage.app",
        messagingSenderId: "364317481294",
        appId: "1:364317481294:web:d2e69c3b82b54b1d0e661f",
        measurementId: "G-G4LH0L728M"
        };


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let geminiApiKey = "";

        // --- AUTH LOGIC ---
        window.login = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (err) { alert(err.message); }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const authControls = document.getElementById('auth-controls');
            const welcome = document.getElementById('user-welcome');
            
            if (user) {
                currentUser = user;
                welcome.innerText = `Halo, ${user.displayName}! üëã`;
                authControls.innerHTML = `
                    <button onclick="toggleSettings(true)" class="p-2 hover:bg-gray-100 rounded-lg">‚öôÔ∏è</button>
                    <button onclick="logout()" class="text-xs font-bold text-red-500 px-3 border border-red-100 rounded-lg">Logout</button>
                `;
                // Ambil API Key dari Firestore
                fetchUserConfig(user.uid);
            } else {
                currentUser = null;
                geminiApiKey = "";
                welcome.innerText = "Silakan login untuk menyimpan resep.";
                authControls.innerHTML = `<button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md shadow-blue-200">Login Google</button>`;
                document.getElementById('api-warning').classList.remove('hidden');
            }
        });

        // --- FIRESTORE LOGIC ---
        async function fetchUserConfig(uid) {
            const docRef = doc(db, "users", uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                geminiApiKey = docSnap.data().geminiKey;
                document.getElementById('api-warning').classList.add('hidden');
            } else {
                document.getElementById('api-warning').classList.remove('hidden');
            }
        }

        window.saveApiKeyToCloud = async () => {
            if (!currentUser) return alert("Login dulu!");
            const key = document.getElementById('api-key-input').value.trim();
            if (!key) return;

            try {
                await setDoc(doc(db, "users", currentUser.uid), { geminiKey: key });
                geminiApiKey = key;
                alert("Tersimpan di Cloud!");
                toggleSettings(false);
                document.getElementById('api-warning').classList.add('hidden');
            } catch (err) { alert("Gagal simpan: " + err.message); }
        };

        // --- GEMINI LOGIC ---
        window.generateRecipe = async () => {
            if (!geminiApiKey) {
                alert("API Key belum disetel di pengaturan!");
                return toggleSettings(true);
            }

            const ingredients = document.getElementById('ingredients').value;
            if (!ingredients) return alert("Isi bahannya!");

            const loading = document.getElementById('loading');
            const resultCard = document.getElementById('recipe-card');
            const content = document.getElementById('recipe-content');

            loading.classList.remove('hidden');
            resultCard.classList.add('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Resep kreatif dari bahan: ${ingredients}. Gunakan Markdown.` }] }] })
                });

                const data = await response.json();
                const md = data.candidates[0].content.parts[0].text;
                content.innerHTML = marked.parse(md);
                resultCard.classList.remove('hidden');
            } catch (err) { alert("Error: " + err.message); }
            finally { loading.classList.add('hidden'); }
        };

        window.toggleSettings = (show) => {
            document.getElementById('settings-modal').classList.toggle('hidden', !show);
            if(show) document.getElementById('api-key-input').value = geminiApiKey;
        };
    </script>
</body>
</html>